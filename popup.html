<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      body {
        width: 256px;
        font-family: Helvetica, Arial, sans-serif;
        font-size: small;
      }
      #notes {
        color: #222222;
      }
    </style>
    <script type="text/javascript">
      var bgPage = chrome.extension.getBackgroundPage();
      
      function getHostFromUrl(url) {
        var a_element = document.createElement("a");
        a_element.href = url;
        return a_element.hostname;
      }

      function retrievePageNotes(tab) {
        var notes = document.getElementById("notes");
        // Get notes for the current tab and display.
        notes.innerHTML = "&nbsp;";
        tabUrl = tab.url;
        tabHost = getHostFromUrl(tabUrl);
        if(bgPage.getPageNotes(tabUrl)) {
          notes.innerHTML = bgPage.getPageNotes(tabUrl);
        } else if(bgPage.getPageNotes(tabHost)) {
          notes.innerHTML = bgPage.getPageNotes(tabHost);
          document.getElementById("site-level").checked = true;
        } else {
          document.getElementById("save-edit-button").value = "Edit";
          document.getElementById("save-edit-button").innerHTML = "Add";
          document.getElementById("site-level-div").style.display = "none";
        }
        // Add event listener to the Edit/Save button.
        document.getElementById("save-edit-button").addEventListener("click", function() {
          if(this.value == "Edit") {
            notes.contentEditable = true;
            notes.focus();
            document.getElementById("site-level-div").style.display = "block";
            this.innerHTML = "Save";
            this.value = "Save";
          } else if(this.value == "Save") {
            notes.contentEditable = false;
            if (document.getElementById("site-level").checked == false) {
              bgPage.setPageNotes(tabUrl, notes.innerHTML);
            } else {
              bgPage.setPageNotes(tabHost, notes.innerHTML);
            }
            localStorage[last_mod_time] = new Date.getTime();
            this.innerHTML = "Edit";
            this.value = "Edit";
            window.close();
          }
        });
        // Add event listener to the Delete button.
        document.getElementById("delete-button").addEventListener("click", function() {
          key = tabUrl;
          if (document.getElementById("site-level").checked) {
            key = tabHost;
          }
          bgPage.removePageNotes(key);
          localStorage[last_mod_time] = new Date.getTime();
          window.close();
        });
        // Add event listner to the site-level checkbox
        document.getElementById("site-level").addEventListener("change", function() {
          document.getElementById("save-edit-button").value = "Save";
          document.getElementById("save-edit-button").innerHTML = "Save";
        });
      }
      // Chrome extensions API call to get the current tab (URL).
      chrome.tabs.getSelected(null, retrievePageNotes);
    </script>
    <title>Page Notes</title>
  </head>
  <body>
    <div id="notes">
    </div>
    <div id="site-level-div" style="display:block; margin-bottom:5px; margin-top:10px;">
      <input type="checkbox" name="site-level" id="site-level"/>
      Site Level Notes
    </div>
    <button id="save-edit-button" value="Edit">
      Edit
    </button>
    <button id="delete-button" value="Delete">
      Delete
    </button>
  </body>
</html>
