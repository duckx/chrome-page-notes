<!DOCTYPE html>
<!--
* Author: Manu Garg <manugarg@gmail.com>
-->
<html>
  <head>
    <style type="text/css">
      body {
        width: 256px;
        font-family: Helvetica, Arial, sans-serif;
        font-size: small;
      }
      #notes {
        color: #222222;
      }
    </style>
    <script type="text/javascript">
      var bgPage = chrome.extension.getBackgroundPage();

      function e(id) {
        return document.getElementById(id);
      }

      function retrievePageNotes(tab) {
        var notes = e("notes");
        var editButton = e('editbutton');

        // Get notes for the current tab and display.
        notes.innerHTML = "&nbsp;";
        tabUrl = tab.url;
        tabHost = bgPage.getHostFromUrl(tabUrl);
        if(bgPage.getPageNotes(tabUrl)) {
          notes.innerHTML = bgPage.getPageNotes(tabUrl);
        } else if(bgPage.getPageNotes(tabHost)) {
          notes.innerHTML = bgPage.getPageNotes(tabHost);
          e("site-level").checked = true;
        } else {
          editButton.value = "Edit";
          editButton.innerHTML = "Add";
          e("site-level-div").style.display = "none";
        }

        // Add event listener to the Edit/Save button.
        editButton.addEventListener("click", function() {
          if (this.value == "Edit") {
            notes.contentEditable = true;
            notes.focus();
            e("site-level-div").style.display = "block";
            this.innerHTML = "Save";
            this.value = "Save";
          } else if (this.value == "Save") {
            notes.contentEditable = false;
            if (e("site-level").checked == false) {
              bgPage.setPageNotes(tabUrl, notes.innerHTML);
            } else {
              bgPage.setPageNotes(tabHost, notes.innerHTML);
            }
            localStorage.lastModTime = new Date().getTime();
            window.close();
          }
        });
        // Add event listener to the Delete button.
        e("delete-button").addEventListener("click", function() {
          key = tabUrl;
          if (e("site-level").checked) {
            key = tabHost;
          }
          bgPage.removePageNotes(key);
          localStorage.lastModTime = new Date().getTime();
          window.close();
        });
        // Add event listner to the site-level checkbox
        e("site-level").addEventListener("change", function() {
          editButton.value = "Save";
          editButton.innerHTML = "Save";
        });
      }

      // Chrome extensions API call to get the current tab (URL).
      chrome.tabs.getSelected(null, retrievePageNotes);
    </script>
    <title>Page Notes</title>
  </head>
  <body>
    <div id="notes">
    </div>
    <div id="site-level-div" style="display:block; margin-bottom:5px; margin-top:10px;">
      <input type="checkbox" name="site-level" id="site-level"/>
      Site Level Notes
    </div>
    <button id="editbutton" value="Edit">
      Edit
    </button>
    <button id="delete-button" value="Delete">
      Delete
    </button>
  </body>
</html>
