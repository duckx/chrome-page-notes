<html>
  <head>
    <script type="text/javascript" src="chrome_ex_oauthsimple.js"></script>
    <script type="text/javascript" src="chrome_ex_oauth.js"></script>
    <script type="text/javascript" src="gdocs.js"></script>
    <script type="text/javascript" src="pagenotes.js"></script>
    <script type="text/javascript">
      var SYNC_INTERVAL = 5 * 60 * 1000; // In ms. Equivalent to 5 min.
      var DOCLIST_SCOPE = 'https://docs.google.com/feeds';
      var DOCLIST_FEED = DOCLIST_SCOPE + '/default/private/full/';
      var docs = [];
      var requests = [];

      var oauth = ChromeExOAuth.initBackgroundPage({
        'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
        'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
        'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
        'consumer_key': 'anonymous',
        'consumer_secret': 'anonymous',
        'scope': DOCLIST_SCOPE,
        'app_name': 'Page Notes - Chrome Extension'
      });

      function stringify(parameters) {
        var params = [];
        for(var p in parameters) {
          params.push(encodeURIComponent(p) + '=' +
          encodeURIComponent(parameters[p]));
        }
        return params.join('&');
      };

      function clearPendingRequests() {
        for (var i = 0, req; req = requests[i]; ++i) {
          window.clearTimeout(req);
        }
        requests = [];
      };

      function logout() {
        oauth.clearTokens();
        clearPendingRequests();
      };

      function getRemoteLastModTime() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        return gDoc.getLastUpdateTime();
      };

      function syncToRemote() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        gDoc.setData(getAllPageNotes());
        localStorage.lastModTime = gDoc.getLastUpdateTime();
      }

      function syncToLocal() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        setAllPageNotes(gDoc.getData());
        localStorage.lastModTime = gDoc.getLastUpdateTime();
      }

      function sync() {
        if(!oauth.hasToken()) {
          return;
        }
        if(!localStorage['gDoc']) {
          return;
        }

        var gDoc = new GoogleDoc(localStorage.gDoc);
        //        alert(JSON.stringify(gDoc));
        try {
          gDoc.refresh( function() {
            localLastModTime = 0;
            if(localStorage.lastModTime) {
              localLastModTime = localStorage.lastModTime
            }
            remoteLastModTime = getRemoteLastModTime();
            //        alert(localLastModTime);
            //        alert(remoteLastModTime);
            if (remoteLastModTime === localLastModTime)
              return;
            if (remoteLastModTime > localLastModTime) {
              syncToLocal();
            } else {
              syncToRemote();
            }
          });
        } catch (e) {
          localStorage.lastSyncStatus = e;
        }
        localStorage.lastSyncStatus = 'Last synced at: ' + new Date();
      };

      window.setInterval(sync, SYNC_INTERVAL);
    </script>
    <title>Page Notes</title>
  </head>
  <body onload=sync();>
  </body>
</html>