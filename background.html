<html>
  <head>
    <script type="text/javascript" src="chrome_ex_oauthsimple.js"></script>
    <script type="text/javascript" src="chrome_ex_oauth.js"></script>
    <script type="text/javascript" src="gdocs.js"></script>
    <script type="text/javascript" src="pagenotes.js"></script>
    <script type="text/javascript">
      var SYNC_INTERVAL = 5 * 60 * 1000; // In ms. Equivalent to 5 min.
      var DOCLIST_SCOPE = 'https://docs.google.com/feeds';
      var DOCLIST_FEED = DOCLIST_SCOPE + '/default/private/full/';
      var REMOTE_DOC_NAME = 'Page Notes Data'

      var oauth = ChromeExOAuth.initBackgroundPage({
        'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
        'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
        'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
        'consumer_key': 'anonymous',
        'consumer_secret': 'anonymous',
        'scope': DOCLIST_SCOPE,
        'app_name': 'Page Notes - Chrome Extension'
      });

      var debug = {
        msg: '',
        log: function(s) { this.msg += s + '\n';}
      }

      function stringify(parameters) {
        var params = [];
        for(var p in parameters) {
          params.push(encodeURIComponent(p) + '=' +
          encodeURIComponent(parameters[p]));
        }
        return params.join('&');
      };

      function clearPendingRequests() {
        for (var i = 0, req; req = requests[i]; ++i) {
          window.clearTimeout(req);
        }
        requests = [];
      };

      function logout() {
        oauth.clearTokens();
        clearPendingRequests();
      };

      function getRemoteLastModTime() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        return gDoc.getLastUpdateTime();
      };

      function syncToRemote() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        gDoc.setData(getAllPageNotes());
        localStorage.lastModTime = gDoc.getLastUpdateTime();
      }

      function syncToLocal() {
        var gDoc = new GoogleDoc(localStorage.gDoc);
        setAllPageNotes(gDoc.getData());
        localStorage.lastModTime = gDoc.getLastUpdateTime();
      }

      function sync() {

        debug.msg = ''
        debug.log('sync: Starting sync at: ' + new Date());

        if(!oauth.hasToken()) {
          debug.log('sync: No Oauth token found.');
          return;
        }
        if(!localStorage.gDoc) {
          debug.log('sync: Sync gdoc is not setup.');
          return;
        }
        var gDoc = new GoogleDoc(localStorage.gDoc);
        try {
          gDoc.refreshLocalMetadata(function() {
            localLastModTime = 0;
            if(localStorage.lastModTime) {
              localLastModTime = parseInt(localStorage.lastModTime);
            }
            remoteLastModTime = parseInt(getRemoteLastModTime());
            debug.log('sync: Local last mod time: ' + localLastModTime);
            debug.log('sync: Remote last mod time: ' + localLastModTime);
            if (remoteLastModTime === localLastModTime) {
              debug.log('sync: Local and remote data are equally recent.');
              return;
            }
            else if (remoteLastModTime > localLastModTime) {
              debug.log('sync: Remote data is more recent.');
              syncToLocal();
            }
            else {
              debug.log('sync: Local data is more recent.');
              syncToRemote();
            }
          });
        } catch (e) {
          localStorage.lastSyncStatus = e;
          return;
        }
        localStorage.lastSyncStatus = 'Last synced at: ' + new Date();
      };

      window.setInterval(sync, SYNC_INTERVAL);
    </script>
    <title>Page Notes</title>
  </head>
  <body onload=sync();>
  </body>
</html>
