<html>
  <head>
    <script type="text/javascript" src="chrome_ex_oauthsimple.js"></script>
    <script type="text/javascript" src="chrome_ex_oauth.js"></script>
    <script type="text/javascript" src="gdocs.js"></script>
    <script type="text/javascript" src="pagenotes.js"></script>
    <script type="text/javascript">
      var SYNC_INTERVAL = 1000; // In ms. Equivalent to 5 min.
      var DOCLIST_SCOPE = 'https://docs.google.com/feeds';
      var DOCLIST_FEED = DOCLIST_SCOPE + '/default/private/full/';
      var docs = [];
      var requests = [];

      var oauth = ChromeExOAuth.initBackgroundPage({
        'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
        'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
        'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
        'consumer_key': 'anonymous',
        'consumer_secret': 'anonymous',
        'scope': DOCLIST_SCOPE,
        'app_name': 'Page Notes - Chrome Extension'
      });

      function stringify(parameters) {
        var params = [];
        for(var p in parameters) {
          params.push(encodeURIComponent(p) + '=' +
          encodeURIComponent(parameters[p]));
        }
        return params.join('&');
      };

      function clearPendingRequests() {
        for (var i = 0, req; req = requests[i]; ++i) {
          window.clearTimeout(req);
        }
        requests = [];
      };

      function logout() {
        oauth.clearTokens();
        clearPendingRequests();
      };

      function do_oauth(onAuthorized) {
        oauth.authorize(onAuthorized);
      };

      function getRemoteLastModTime() {
        remoteDocEntry = new GdocsEntry(localStorage['remoteDocEntry']);
//        alert(JSON.stringify(remoteDocEntry));
        remoteDocEntry.refresh();   
        return remoteDocEntry.getLastUpdateTime();
      };

      function setRemoteData(data) {
        alert('Setting remote data to' + data);
      };

      function getRemoteData() {
        alert('Getting remote data');
      };

      function syncToRemote() {
        local_data_string = getAllPageNotes();
        setRemoteData(local_data_string);
      }

      function syncToLocal() {
        remote_data_string = getRemoteData();
        setAllPageNotes(remote_data_string);
      }

      function sync() {
        if(!oauth.hasToken())
          return;

        local_last_mod_time = 0;
        if(localStorage['last_mod_time']) {
          local_last_mod_time = localStorage['last_mod_time']
        }
        remote_last_mod_time = getRemoteLastModTime();
       alert(local_last_mod_time);
       alert(remote_last_mod_time);
        if (remote_last_mod_time == local_last_mod_time)
          return;
        if (remote_last_mod_time > local_last_mod_time) {
          syncToLocal();
        } else {
          syncToRemote();
        }
      }
      
//      function sync() {}

//      window.setInterval(sync, SYNC_INTERVAL);
    </script>
    <title>Page Notes</title>
  </head>
  <body onload=sync();>
  </body>
</html>